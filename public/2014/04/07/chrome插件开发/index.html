<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="description" content="Welcome to my blog.">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.17" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/images/favicon.ico">
<link rel="stylesheet" href="http://blog.homfen.me/css/sourcecodepro.css" type="text/css">
<link rel="stylesheet" href="//static.homfen.me/plugin/highlight.js/dist/styles/solarized-dark.css">
<link rel="stylesheet" href="http://blog.homfen.me/css/style.css" type="text/css">
<link rel="alternate" href="http://blog.homfen.me/index.xml" type="application/rss+xml" title="Homfen&#39;s blog">
<title>Chrome插件开发 - Homfen&#39;s blog</title>
</head>
<body>

<header>
  <div class="container clearfix">
    <a class="path" href="http://blog.homfen.me/">[Homfen&#39;s blog]</a>
    <span class="caret"># _</span>
    <div class="right">
      
    </div>
  </div>
</header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2014-04-07">April 07, 2014</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="http://blog.homfen.me/categories/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF">前端技术</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="http://blog.homfen.me/tags/chrome">Chrome</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">Chrome插件开发</h1>
  <section class="body" itemprop="articleBody">
    <!--img src="/images/post/Chrome-Web-Store.jpg"-->

<p>关于谷歌浏览器插件开发的详细内容，可以访问谷歌的文档“<a href="https://developer.chrome.com/extensions/getstarted" target="_blank">Getting Start</a>”，本文主要介绍下简单Chrome插件开发。</p>

<p>简单的Chrome插件包含三个文件，一个manifest.json是配置文件，一个js文件，一个图标。
来看一下manifest.json中的基本配置：</p>

<p></p>

<pre><code class="language-json">{
    &quot;name&quot;: &quot;test&quot;,//插件名称
    &quot;description&quot;: &quot;alert&quot;,//插件描述
    &quot;version&quot;: &quot;0.0.1&quot;,
    &quot;permissions&quot;: [&quot;tabs&quot;,&quot;&lt;all_urls&gt;&quot;],
    &quot;browser_action&quot;: {
        &quot;default_icon&quot;: &quot;test.png&quot;//插件图标，xx.jpg
    },
    &quot;content_scripts&quot;: [{
        &quot;matches&quot;: [
            &quot;http://*/*&quot;,
            &quot;https://*/*&quot;
        ],
        &quot;js&quot;: [&quot;load.js&quot;],//js文件
        &quot;run_at&quot;: &quot;document_end&quot;//在页面加载完时运行
    }], 
    &quot;manifest_version&quot;:2
}
</code></pre>

<p>在load.js中可以对加载完的页面做任何操作<!--more--></p>

<p>编写完成后，把这三个文件放在一个文件夹下，打开Chrome设置，选择左侧Extensions，点击“Load unpacked extension&hellip;”按钮将前面的文件夹加载进来即可。</p>

<p>到这里，我们的插件只能在进入页面的时候进行一些操作，但是少了关键的菜单，下面就来弄个菜单。</p>

<p>第一步，修改manifest，在browser_action中添加一项：</p>

<pre><code class="language-json">&quot;browser_action&quot;: {
    &quot;default_icon&quot;: &quot;test.png&quot;,
    &quot;default_popup&quot;:&quot;popup.html&quot;
}
</code></pre>

<p>其实菜单也是一个html文件，所以是通过html、css来定义它的样式，通过绑定事件来实现功能，popup.html:</p>

<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;
        &lt;title&gt;alert&lt;/title&gt;
        &lt;style&gt;
        div{
            width:100px;
            height:20px;
            line-height:20px;
            text-align:center;
            font-family: sans-serif;
            font-size:0.8em;
            background:#F3F3F3;
            margin-bottom:4px;
            cursor:pointer;
            border-radius:3px;
        }
        div:hover{
            background:#CCCCCC;
        }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div id=&quot;alert&quot;&gt;alert&lt;/div&gt;
        &lt;script src=&quot;popup.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>样式比较简单，只有一个div，也就是一个按钮，通过引入popup.js文件来绑定事件，这里必须通过script标签引入外部的js，而不能写內联js，不然会报错。popup.js:</p>

<pre><code class="language-javascript">document.querySelector(&quot;#alert&quot;).addEventListener(&quot;click&quot;,function(){
    chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        chrome.tabs.sendMessage(tabs[0].id, {action: &quot;showTitle&quot;}, function(response) {
            console.log(&quot;ok&quot;);
        });
    });
});
</code></pre>

<p>给alert绑定了click事件，内部的实现比较有意思，通过chrome.tabs.query来获取当前的tab，然后通过chrome.tabs.sendMessage给当前tab发送消息，popup和content之间就是通过message来通信的，为什么要搞的这么麻烦呢，因为popup和content是相互隔离的，是两个独立的页面，当然不能在一个页面调用另一个页面的方法。load.js:</p>

<pre><code class="language-javascript">function showTitle(){
    alert(document.title);
}

chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {  
    var action = request.action;
    switch(action){
        case &quot;showTitle&quot;:
            showTitle();
            break;
        default:
            console.log(&quot;unknown action&quot;);
            break;
    }
});

console.log(&quot;loaded&quot;);
</code></pre>

<p>load.js里面，通过chrome.runtime.onMessage.addListener来添加一个message监听器，request就是上面sendMessage的第二个参数，通过action的不同调用不同的方法。</p>

<p>按照上面的实现，我们发现只有刷新页面的时候生效，切换tab后就无效了，这时候就要用上了background了，在manifest里面添加background和权限:</p>

<pre><code class="language-json">&quot;permissions&quot;: [&quot;tabs&quot;,&quot;&lt;all_urls&gt;&quot;,&quot;activeTab&quot;],
&quot;background&quot;:{
    &quot;scripts&quot;:[&quot;background.js&quot;]
}
</code></pre>

<p>background的js能够运行在浏览器后台，background.js:</p>

<pre><code class="language-javascript">chrome.tabs.onActivated.addListener(function(activeInfo) {
    chrome.tabs.get(activeInfo.tabId, function (tab) {
        chrome.tabs.executeScript(tab.id,{file:&quot;load.js&quot;});
    });
});
</code></pre>

<p>这里绑定了onActivated事件，即在浏览器切换时会出发，把load.js加载进来，同时我们也要修改load.js避免重复加载,load.js:</p>

<pre><code class="language-javascript">if(!window.loaded){
    console.log(&quot;loaded&quot;);
    window.loaded = true;

    function showTitle(){
        alert(document.title);
    }

    chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {  
        var action = request.action;
        switch(action){
            case &quot;showTitle&quot;:
                showTitle();
                break;
            default:
                console.log(&quot;unknown action&quot;);
                break;
        }
    });
}
</code></pre>

<p>完整的代码放在github上：<a href="https://github.com/homfen/chrome-extension-demo">https://github.com/homfen/chrome-extension-demo</a></p>

<p>所以开发一个Chrome插件也不难。</p>
  </section>
  <section class="body" style="margin-top: 2rem;">
    <div id="disqus_thread"></div>
    <script>
    var disqus_config = function () {
        this.page.url = 'http:\/\/blog.homfen.me\/2014\/04\/07/Chrome插件开发';
        this.page.identifier = 'Chrome插件开发';
    };
    (function() {
    var d = document, s = d.createElement('script');
    s.src = '//homfensblog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </section>
</article>

</main>


</div>

<footer>
  <div class="container">
  <span class="copyright">&copy; <script>document.write((new Date()).getFullYear())</script> Homfen&#39;s blog - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

<script src="//static.homfen.me/plugin/highlight.js/dist/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?ea23518b0514a7b24922188359137040";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</body>
</html>

